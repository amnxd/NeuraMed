<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuraMed - Your Mental Wellness Partner</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #e0f7fa 0%, #d1c4e9 50%, #e1f5fe 100%);
            overflow-x: hidden;
        }
        #bg-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: -1;
        }
        .text-shadow {
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        #breathing-circle {
            transition: all 4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #breathing-circle.grow {
            transform: scale(1.5);
            background-color: #a7f3d0;
        }
        #breathing-circle.hold {
            background-color: #bfdbfe;
        }
        #breathing-circle.shrink {
            transform: scale(1);
            background-color: #ddd6fe;
        }
    </style>
    </head>
<body class="text-gray-800">

    <canvas id="bg-canvas"></canvas>

    <header class="fixed top-0 left-0 right-0 z-50">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center bg-white/50 backdrop-blur-lg rounded-b-xl shadow-sm">
            
            <a href="#" class="text-3xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-blue-500 to-teal-500" data-page="page-home">
                NeuraMed
            </a>

            <div class="hidden md:flex space-x-6">
                <a href="#" class="text-gray-600 hover:text-blue-600 transition-colors" data-page="page-support-group">Support Group</a>
                <a href="#" class="text-gray-600 hover:text-blue-600 transition-colors" data-page="page-peers">Peers Calls</a>
                <a href="#" class="text-gray-600 hover:text-blue-600 transition-colors" data-page="page-take-test">Take a Test</a>
                <a href="#" class="text-gray-600 hover:text-blue-600 transition-colors" data-page="page-games">Games</a>
                <a href="#" class="text-gray-600 hover:text-blue-600 transition-colors" data-page="page-research">Research</a>
                <a href="#" class="text-gray-600 hover:text-blue-600 transition-colors" data-page="page-shop">Shop</a>
            </div>

            <div class="flex items-center space-x-2">
                <button class="p-2 rounded-full hover:bg-gray-100/50 transition-colors relative" data-page="page-shop">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    <span id="cart-count" class="hidden absolute -top-1 -right-1 bg-red-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center">0</span>
                </button>
                
                <button class="px-4 py-2 text-sm font-medium text-blue-600 hover:bg-blue-50 rounded-full transition-colors" data-page="page-login">
                    Login
                </button>
                <button class="px-4 py-2 text-sm font-medium text-white bg-blue-500 hover:bg-blue-600 rounded-full transition-colors" data-page="page-signup">
                    Sign Up
                </button>
                
                <button id="menu-btn" class="md:hidden p-2 rounded-md hover:bg-gray-100/50 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-700" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16m-7 6h7" />
                    </svg>
                </button>
            </div>
        </nav>

        <div id="mobile-menu" class="hidden md:hidden fixed top-20 left-0 right-0 mx-4 rounded-lg shadow-xl bg-white/90 backdrop-blur-lg z-40">
            <a href="#" class="block px-6 py-3 text-gray-700 hover:bg-blue-50 transition-colors rounded-t-lg" data-page="page-support-group">Support Group</a>
            <a href="#" class="block px-6 py-3 text-gray-700 hover:bg-blue-50 transition-colors" data-page="page-peers">Peers Calls</a>
            <a href="#" class="block px-6 py-3 text-gray-700 hover:bg-blue-50 transition-colors" data-page="page-take-test">Take a Test</a>
            <a href="#" class="block px-6 py-3 text-gray-700 hover:bg-blue-50 transition-colors" data-page="page-games">Games</a>
            <a href="#" class="block px-6 py-3 text-gray-700 hover:bg-blue-50 transition-colors" data-page="page-research">Research</a>
            <a href="#" class="block px-6 py-3 text-gray-700 hover:bg-blue-50 transition-colors" data-page="page-shop">Shop</a>
            <a href="#" class="block px-6 py-3 text-gray-700 hover:bg-blue-50 transition-colors" data-page="page-login">Login</a>
            <a href="#" class="block px-6 py-3 text-gray-700 hover:bg-blue-50 transition-colors rounded-b-lg" data-page="page-signup">Sign Up</a>
        </div>
    </header>

    <main id="app-container" class="relative z-10 pt-24 pb-12">

        <section id="page-home" class="min-h-screen flex flex-col items-center justify-center text-center px-6">
            <h1 class="text-5xl md:text-7xl font-bold text-gray-800 text-shadow leading-tight">Find Your Calm.</h1>
            <h2 class="text-5xl md:text-7xl font-bold text-gray-700 text-shadow leading-tight mt-2">Begin Your Journey.</h2>
            <p class="text-lg md:text-xl text-gray-600 mt-8 max-w-2xl text-shadow">
                Personalized mental wellness, designed to bring peace and clarity to your everyday life. You are not alone.
            </p>
            <button id="open-chatbot-btn" class="mt-12 px-8 py-4 bg-gradient-to-r from-blue-500 to-teal-500 text-white font-semibold rounded-full shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-300 ease-in-out">
                Take a Free Wellness Test
            </button>
        </section>

        <section id="page-login" class="hidden min-h-screen container mx-auto px-6">
            <div class="bg-white/50 backdrop-blur-lg rounded-xl shadow-lg p-6 md:p-10 max-w-md mx-auto">
                <h2 class="text-4xl font-bold text-gray-800 mb-8 text-center">Welcome Back</h2>
                <form id="login-form" class="space-y-6">
                    <div>
                        <label for="login-username" class="block text-sm font-medium text-gray-700">Username</label>
                        <input type="text" id="login-username" name="username" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="login-password" name="password" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                    <button type="submit" class="w-full px-8 py-3 bg-blue-500 text-white font-semibold rounded-full hover:bg-blue-600 transition-colors shadow-lg">Login</button>
                </form>
                <p class="text-center text-gray-600 mt-6">
                    Don't have an account? 
                    <a href="#" class="font-medium text-blue-600 hover:underline" data-page="page-signup">Sign Up</a>
                </p>
            </div>
        </section>

        <section id="page-signup" class="hidden min-h-screen container mx-auto px-6">
            <div class="bg-white/50 backdrop-blur-lg rounded-xl shadow-lg p-6 md:p-10 max-w-md mx-auto">
                <h2 class="text-4xl font-bold text-gray-800 mb-8 text-center">Create Account</h2>
                <form id="signup-form" class="space-y-6">
                    <div>
                        <label for="signup-username" class="block text-sm font-medium text-gray-700">Username</label>
                        <input type="text" id="signup-username" name="username" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                    <div>
                        <label for="signup-password" class="block text-sm font-medium text-gray-700">Password</label>
                        <input type="password" id="signup-password" name="password" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                    <div>
                        <label for="signup-confirm-password" class="block text-sm font-medium text-gray-700">Confirm Password</label>
                        <input type="password" id="signup-confirm-password" name="confirm-password" required class="mt-1 block w-full px-4 py-3 border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-400">
                    </div>
                    <button type="submit" class="w-full px-8 py-3 bg-blue-500 text-white font-semibold rounded-full hover:bg-blue-600 transition-colors shadow-lg">Create Account</button>
                </form>
                <p class="text-center text-gray-600 mt-6">
                    Already have an account? 
                    <a href="#" class="font-medium text-blue-600 hover:underline" data-page="page-login">Login</a>
                </p>
            </div>
        </section>

        <section id="page-research" class="hidden min-h-screen container mx-auto px-6">
            <div class="bg-white/50 backdrop-blur-lg rounded-xl shadow-lg p-6 md:p-10">
                <h2 class="text-4xl font-bold text-gray-800 mb-8 text-center">Participate in Research</h2>
                <p class="text-lg text-gray-600 text-center max-w-3xl mx-auto mb-10">
                    Help advance mental health science by participating in our partner studies. 
                    All participants are compensated for their time.
                </p>
                <div id="research-list-container" class="space-y-6 max-w-4xl mx-auto">
                </div>
            </div>
        </section>

        <section id="page-support-group" class="hidden min-h-screen container mx-auto px-6">
            <div class="bg-white/50 backdrop-blur-lg rounded-xl shadow-lg p-6 md:p-10">
                <h2 class="text-4xl font-bold text-gray-800 mb-8 text-center">Find Your Consultant</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <div class="bg-white rounded-lg shadow-md p-6 text-center flex flex-col items-center">
                        <img src="https://placehold.co/100x100/d1c4e9/FFFFFF?text=Dr.+E" alt="Doctor" class="w-24 h-24 rounded-full mb-4 border-4 border-blue-200">
                        <h3 class="text-xl font-semibold text-gray-800">Dr. Evelyn Reed</h3>
                        <p class="text-gray-600 mb-4">Ph.D. in Clinical Psychology</p>
                        <p class="text-gray-500 text-sm mb-4">Specializes in anxiety, stress management, and CBT.</p>
                        <button class="w-full px-6 py-2 bg-blue-500 text-white font-semibold rounded-full hover:bg-blue-600 transition-colors">Book a Session</button>
                    </div>
                    <div class="bg-white rounded-lg shadow-md p-6 text-center flex flex-col items-center">
                        <img src="https://placehold.co/100x100/e0f7fa/333333?text=Dr.+M" alt="Doctor" class="w-24 h-24 rounded-full mb-4 border-4 border-teal-200">
                        <h3 class="text-xl font-semibold text-gray-800">Dr. Marcus Cole</h3>
                        <p class="text-gray-600 mb-4">Psy.D, LMFT</p>
                        <p class="text-gray-500 text-sm mb-4">Specializes in relationship counseling and family therapy.</p>
                        <button class="w-full px-6 py-2 bg-teal-500 text-white font-semibold rounded-full hover:bg-teal-600 transition-colors">Book a Session</button>
                    </div>
                    <div class="bg-white rounded-lg shadow-md p-6 text-center flex flex-col items-center">
                        <img src="https://placehold.co/100x100/e1f5fe/333333?text=Dr.+S" alt="Doctor" class="w-24 h-24 rounded-full mb-4 border-4 border-purple-200">
                        <h3 class="text-xl font-semibold text-gray-800">Dr. Sarah Chen</h3>
                        <p class="text-gray-600 mb-4">MD, Psychiatrist</p>
                        <p class="text-gray-500 text-sm mb-4">Specializes in depression, medication management, and trauma.</p>
                        <button class="w-full px-6 py-2 bg-blue-500 text-white font-semibold rounded-full hover:bg-blue-600 transition-colors">Book a Session</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="page-peers" class="hidden min-h-screen container mx-auto px-6">
            <div class="bg-white/50 backdrop-blur-lg rounded-xl shadow-lg p-6 md:p-10">
                <h2 class="text-4xl font-bold text-gray-800 mb-8 text-center">Connect with a Peer</h2>
                <div class="space-y-6 max-w-3xl mx-auto">
                    <div class="bg-white rounded-lg shadow-md p-6 flex flex-col md:flex-row items-center justify-between space-y-4 md:space-y-0 md:space-x-6">
                        <div class="flex items-center space-x-4">
                            <div class="w-16 h-16 rounded-full bg-blue-100 flex items-center justify-center text-2xl font-bold text-blue-600">A</div>
                            <div>
                                <h3 class="text-xl font-semibold text-gray-800">Anonymous Peer</h3>
                                <p class="text-gray-600">"I've learned to manage my daily anxiety, and I'm here to listen."</p>
                            </div>
                        </div>
                        <button class="w-full md:w-auto px-6 py-2 bg-green-500 text-white font-semibold rounded-full hover:bg-green-600 transition-colors">Connect Anonymously</button>
                    </div>
                    <div class="bg-white rounded-lg shadow-md p-6 flex flex-col md:flex-row items-center justify-between space-y-4 md:space-y-0 md:space-x-6">
                        <div class="flex items-center space-x-4">
                            <div class="w-16 h-16 rounded-full bg-purple-100 flex items-center justify-center text-2xl font-bold text-purple-600">J</div>
                            <div>
                                <h3 class="text-xl font-semibold text-gray-800">Anonymous Peer</h3>
                                <p class="text-gray-600">"Recovering from a tough relationship taught me a lot. Happy to share."</p>
                            </div>
                        </div>
                        <button class="w-full md:w-auto px-6 py-2 bg-green-500 text-white font-semibold rounded-full hover:bg-green-600 transition-colors">Connect Anonymously</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="page-take-test" class="hidden min-h-screen container mx-auto px-6">
            <div class="bg-white/50 backdrop-blur-lg rounded-xl shadow-lg p-6 md:p-10">
                
                <div id="test-selection" class="">
                    <h2 class="text-4xl font-bold text-gray-800 mb-8 text-center">Choose Your Assessment</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <button data-test="anxiety" class="test-choice-btn text-left p-6 bg-white rounded-lg shadow-md hover:shadow-xl transition-shadow">
                            <h3 class="text-xl font-semibold text-blue-600">Anxiety Test</h3>
                            <p class="text-gray-600 mt-2">Check your anxiety levels and learn about symptoms.</p>
                        </button>
                        <button data-test="depression" class="test-choice-btn text-left p-6 bg-white rounded-lg shadow-md hover:shadow-xl transition-shadow">
                            <h3 class="text-xl font-semibold text-purple-600">Depression Test</h3>
                            <p class="text-gray-600 mt-2">A self-assessment based on common depression indicators.</p>
                        </button>
                        <button data-test="relationship" class="test-choice-btn text-left p-6 bg-white rounded-lg shadow-md hover:shadow-xl transition-shadow">
                            <h3 class="text-xl font-semibold text-teal-600">Relationship Health</h3>
                            <p class="text-gray-600 mt-2">Evaluate your satisfaction and dynamics in your relationship.</p>
                        </button>
                    </div>
                </div>

                <div id="test-interface" class="hidden max-w-2xl mx-auto">
                    <h2 id="test-title" class="text-3xl font-bold text-gray-800 mb-6 text-center"></h2>
                    <div class="bg-white rounded-lg shadow-inner h-96 p-4 overflow-y-auto flex flex-col space-y-4" id="test-chat-log">
                        </div>

                    <form id="test-form" class="mt-4 flex space-x-2 hidden">
                        <input type="text" id="test-input" placeholder="Type your answer..." class="flex-1 p-3 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-400">
                        <button type="submit" class="px-6 py-3 bg-blue-500 text-white font-semibold rounded-full hover:bg-blue-600 transition-colors">Send</button>
                    </form>

                    <div id="test-options" class="mt-4 flex flex-wrap justify-center gap-3">
                        </div>

                    <button id="test-back-btn" class="mt-4 text-sm text-gray-600 hover:text-blue-600">&larr; Back to all tests</button>
                </div>

            </div>
        </section>
        <section id="page-games" class="hidden min-h-screen container mx-auto px-6">
            <div class="bg-white/50 backdrop-blur-lg rounded-xl shadow-lg p-6 md:p-10 flex flex-col items-center">
                <h2 class="text-4xl font-bold text-gray-800 mb-8 text-center">Mindful Games</h2>
                <p class="text-lg text-gray-600 mb-8 text-center">Let's practice mindful breathing.</p>
                <div class="w-64 h-64 rounded-full bg-white/70 flex items-center justify-center text-center shadow-xl" id="breathing-circle">
                    <span id="breathing-text" class="text-3xl font-semibold text-gray-700 transition-all duration-1000">Get Ready...</span>
                </div>
                <button id="start-breathing-btn" class="mt-8 px-8 py-3 bg-gradient-to-r from-teal-400 to-blue-400 text-white font-semibold rounded-full shadow-lg hover:shadow-xl transform hover:scale-105 transition-all">
                    Start
                </button>
            </div>
        </section>

        <section id="page-shop" class="hidden min-h-screen container mx-auto px-6">
            <div class="bg-white/50 backdrop-blur-lg rounded-xl shadow-lg p-6 md:p-10">
                <h2 class="text-4xl font-bold text-gray-800 mb-8 text-center">Calming Tools</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
                    <div class="bg-white rounded-lg shadow-md p-6 flex flex-col">
                        <div class="h-48 bg-gray-100 rounded-lg flex items-center justify-center mb-4">
                           <img src="https://placehold.co/150x150/d1c4e9/FFFFFF?text=Fidget+Cube" alt="Fidget Toy" class="w-36 h-36 object-cover rounded">
                        </div>
                        <h3 class="text-xl font-semibold text-gray-800">Fidget Cube</h3>
                        <p class="text-gray-600 mb-4 text-lg font-medium">$12.99</p>
                        <div class="mt-auto flex space-x-2">
                            <button class="add-to-cart-btn w-full px-6 py-2 bg-teal-500 text-white font-semibold rounded-full hover:bg-teal-600 transition-colors">Add to Cart</button>
                            <a href="#" class="w-full text-center px-6 py-2 bg-gray-200 text-gray-700 font-semibold rounded-full hover:bg-gray-300 transition-colors">Download</a>
                        </div>
                    </div>
                    <div class="bg-white rounded-lg shadow-md p-6 flex flex-col">
                        <div class="h-48 bg-gray-100 rounded-lg flex items-center justify-center mb-4">
                           <img src="https://placehold.co/150x150/e0f7fa/333333?text=Spinner" alt="Fidget Toy" class="w-36 h-36 object-cover rounded">
                        </div>
                        <h3 class="text-xl font-semibold text-gray-800">Infinity Spinner</h3>
                        <p class="text-gray-600 mb-4 text-lg font-medium">$19.99</p>
                        <div class="mt-auto flex space-x-2">
                            <button class="add-to-cart-btn w-full px-6 py-2 bg-teal-500 text-white font-semibold rounded-full hover:bg-teal-600 transition-colors">Add to Cart</button>
                            <a href="#" class="w-full text-center px-6 py-2 bg-gray-200 text-gray-700 font-semibold rounded-full hover:bg-gray-300 transition-colors">Download</a>
                        </div>
                    </div>
                </div>
            </div>
        </section>

    </main>

    <footer class="relative z-10 text-center p-6 text-gray-500">
        &copy; 2025 NeuraMed. All rights reserved.
    </footer>

    <div id="chatbot-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl flex flex-col" style="height: 80vh;">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 class="text-3xl md:text-4xl font-bold mb-6 bg-gradient-to-r from-blue-600 via-teal-600 to-emerald-600 bg-clip-text text-transparent">CereSukh</h3>
                
                <div class="flex items-center space-x-2">
                    <select id="language-select" class="text-sm rounded-md border-gray-300 shadow-sm focus:ring-blue-500 focus:border-blue-500" aria-label="Select language">
                        <option value="en-US">English</option>
                        <option value="hi-IN">हिन्दी (Hindi)</option>
                        <option value="bn-IN">বাংলা (Bengali)</option>
                        <option value="ur-IN">اردو (Urdu)</option>
                        <option value="ta-IN">தமிழ் (Tamil)</option>
                        <option value="te-IN">తెలుగు (Telugu)</option>
                        <option value="mr-IN">मराठी (Marathi)</option>
                        <option value="gu-IN">ગુજરાતી (Gujarati)</option>
                        <option value="kn-IN">ಕನ್ನಡ (Kannada)</option>
                        <option value="ml-IN">മലയാളം (Malayalam)</option>
                        <option value="pa-IN">ਪੰਜਾਬੀ (Punjabi)</option>
                        <option value="es-ES">Español</option>
                        <option value="fr-FR">Français</option>
                        <option value="de-DE">Deutsch</option>
                        <option value="zh-CN">中文 (Mandarin)</option>
                        <option value="ja-JP">日本語 (Japanese)</option>
                        <option value="ar-SA">العربية (Arabic)</option>
                        <option value="pt-PT">Português</option>
                        <option value="ru-RU">Русский (Russian)</option>
                    </select>

                    <button id="close-chatbot-btn" class="p-2 rounded-full hover:bg-gray-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                </div>
            </div>
            <div id="chatbot-log" class="flex-1 p-4 overflow-y-auto space-y-4">
                <div class="flex">
                    <div class="p-3 bg-blue-100 text-gray-800 rounded-lg max-w-xs md:max-w-md">
                        <p>Hello! I'm your AI Wellness Assistant. How are you feeling today? You can talk to me about anything on your mind.</p>
                    </div>
                </div>
            </div>
            
            <form id="chatbot-form" class="p-4 border-t flex space-x-2">
                <input type="text" id="chatbot-input" placeholder="Type or press the mic to talk..." class="flex-1 p-3 border rounded-full focus:outline-none focus:ring-2 focus:ring-blue-400">
                
                <button type="button" id="mic-btn" class="p-3 w-12 h-12 flex-shrink-0 rounded-full hover:bg-gray-200 transition-colors flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
                    </svg>
                </button>
                <button type="submit" class="px-6 py-3 bg-blue-500 text-white font-semibold rounded-full hover:bg-blue-600 transition-colors">Send</button>
            </form>
            <div class="p-4 bg-gray-50 rounded-b-xl text-center">
                <p class="text-sm text-gray-600 mb-2">If you're not satisfied or need further help:</p>
                <button id="redirect-to-doctor-btn" class="text-sm font-semibold text-blue-600 hover:underline">
                    Connect with a professional consultant &rarr;
                </button>
            </div>
        </div>
    </div>


    <div id="message-modal" class="hidden fixed inset-0 z-[70] flex items-center justify-center bg-black/50 backdrop-blur-sm p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm">
            <div class="flex justify-between items-center p-4 border-b">
                <h3 id="message-modal-title" class="text-xl font-semibold text-gray-800">Message</h3>
                <button id="close-message-btn" class="p-2 rounded-full hover:bg-gray-200">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="p-6">
                <p id="message-modal-text" class="text-gray-700">This is a message.</p>
            </div>
            <div class="p-4 bg-gray-50 rounded-b-xl text-right">
                <button id="ok-message-btn" class="px-6 py-2 bg-blue-500 text-white font-semibold rounded-full hover:bg-blue-600 transition-colors">
                    OK
                </button>
            </div>
        </div>
    </div>
    
    <script>
        // --- Base URL for the API ---
        const API_URL = 'http://127.0.0.1:5000';

        // --- Three.js Calming Background ---
        let scene, camera, renderer, particles, geometry, originalPositions;
        function initThree() {
            try {
                const canvas = document.getElementById('bg-canvas');
                scene = new THREE.Scene();
                scene.fog = new THREE.Fog(0xd1c4e9, 300, 1000);
                camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 2000);
                camera.position.z = 500;
                renderer = new THREE.WebGLRenderer({ canvas: canvas, alpha: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
                renderer.setClearAlpha(0);
                
                const particleTexture = createParticleTexture();
                const particleCount = 10000;
                const vertices = [];
                for (let i = 0; i < particleCount; i++) {
                    const x = Math.random() * 2000 - 1000;
                    const y = Math.random() * 2000 - 1000;
                    const z = Math.random() * 1000 - 500;
                    vertices.push(x, y, z);
                }
                geometry = new THREE.BufferGeometry();
                geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
                originalPositions = new Float32Array(vertices);
                geometry.setAttribute('originalPosition', new THREE.Float32BufferAttribute(originalPositions, 3));
                
                const material = new THREE.PointsMaterial({
                    color: 0xffffff, size: 3, map: particleTexture,
                    transparent: true, opacity: 0.6,
                    blending: THREE.NormalBlending, depthWrite: false
                });
                particles = new THREE.Points(geometry, material);
                scene.add(particles);
                
                window.addEventListener('resize', onWindowResize, false);
                animate();
            } catch (e) {
                console.error("Error initializing three.js:", e);
                const canvas = document.getElementById('bg-canvas');
                if (canvas) canvas.style.display = 'none';
            }
        }
        function createParticleTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 32; canvas.height = 32;
            const context = canvas.getContext('2d');
            const gradient = context.createRadialGradient(16, 16, 0, 16, 16, 16);
            gradient.addColorStop(0, 'rgba(255, 255, 255, 1)');
            gradient.addColorStop(0.2, 'rgba(255, 255, 255, 0.8)');
            gradient.addColorStop(0.8, 'rgba(255, 255, 255, 0.2)');
            gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');
            context.fillStyle = gradient;
            context.fillRect(0, 0, 32, 32);
            return new THREE.CanvasTexture(canvas);
        }
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        }
        function animate() {
            requestAnimationFrame(animate);
            const time = Date.now() * 0.0001;
            particles.rotation.x = time * 0.1;
            particles.rotation.y = time * 0.05;
            const positions = geometry.attributes.position.array;
            const originals = geometry.attributes.originalPosition.array;
            for (let i = 0; i < positions.length; i += 3) {
                positions[i + 1] = originals[i + 1] + Math.sin(time * 2 + originals[i]) * 10;
                positions[i] = originals[i] + Math.cos(time + originals[i + 2]) * 5;
            }
            geometry.attributes.position.needsUpdate = true;
            renderer.render(scene, camera);
        }
        window.onload = initThree;

        // --- App Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- Global Element Selectors ---
            const allPages = document.querySelectorAll('#app-container > section');
            const navLinks = document.querySelectorAll('[data-page]');
            const menuBtn = document.getElementById('menu-btn');
            const mobileMenu = document.getElementById('mobile-menu');
            
            // Chatbot Modal
            const chatbotModal = document.getElementById('chatbot-modal');
            const openChatbotBtn = document.getElementById('open-chatbot-btn');
            const closeChatbotBtn = document.getElementById('close-chatbot-btn');
            const redirectToDoctorBtn = document.getElementById('redirect-to-doctor-btn');
            const chatbotForm = document.getElementById('chatbot-form');
            const chatbotInput = document.getElementById('chatbot-input');
            const chatbotLog = document.getElementById('chatbot-log');
            const micBtn = document.getElementById('mic-btn'); 
            const languageSelect = document.getElementById('language-select'); 

            // Message Modal (for alerts)
            const messageModal = document.getElementById('message-modal');
            const messageModalTitle = document.getElementById('message-modal-title');
            const messageModalText = document.getElementById('message-modal-text');
            const closeMessageBtn = document.getElementById('close-message-btn');
            const okMessageBtn = document.getElementById('ok-message-btn');

            // Auth Forms
            const loginForm = document.getElementById('login-form');
            const signupForm = document.getElementById('signup-form');

            // Research
            const researchContainer = document.getElementById('research-list-container');
            
            // --- Helper Functions ---

            function showPage(pageId) {
                allPages.forEach(page => page.classList.add('hidden'));
                const targetPage = document.getElementById(pageId);
                if (targetPage) {
                    targetPage.classList.remove('hidden');
                    window.scrollTo(0, 0);
                }
                if (mobileMenu) mobileMenu.classList.add('hidden');
            }

            function showMessage(title, text, isError = false) {
                if (!messageModal || !messageModalTitle || !messageModalText) return;
                messageModalTitle.textContent = title;
                messageModalText.textContent = text;
                messageModalTitle.className = isError 
                    ? "text-xl font-semibold text-red-600" 
                    : "text-xl font-semibold text-gray-800";
                messageModal.classList.remove('hidden');
            }

            function closeMessageModal() {
                if (messageModal) messageModal.classList.add('hidden');
            }
            if (closeMessageBtn) closeMessageBtn.addEventListener('click', closeMessageModal);
            if (okMessageBtn) okMessageBtn.addEventListener('click', closeMessageModal);


            // --- Page Navigation ---
            if (menuBtn) {
                menuBtn.addEventListener('click', () => {
                    if (mobileMenu) mobileMenu.classList.toggle('hidden');
                });
            }
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const pageId = link.getAttribute('data-page');
                    showPage(pageId);
                });
            });

            // --- Authentication Logic ---

            if (signupForm) {
                signupForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const username = document.getElementById('signup-username').value;
                    const pass1 = document.getElementById('signup-password').value;
                    const pass2 = document.getElementById('signup-confirm-password').value;

                    if (pass1 !== pass2) {
                        showMessage("Sign Up Error", "Passwords do not match.", true);
                        return;
                    }

                    try {
                        const response = await fetch(`${API_URL}/signup`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ username, password: pass1 })
                        });
                        const data = await response.json();
                        if (!response.ok) throw new Error(data.error || "Unknown error");
                        
                        showMessage("Success!", "Account created successfully. Please log in.");
                        showPage('page-login');
                        signupForm.reset();
                    } catch (error) {
                        showMessage("Sign Up Error", `Failed to create account: ${error.message}`, true);
                    }
                });
            }

            if (loginForm) {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const username = document.getElementById('login-username').value;
                    const password = document.getElementById('login-password').value;

                    try {
                        const response = await fetch(`${API_URL}/login`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ username, password })
                        });
                        const data = await response.json();
                        if (!response.ok) throw new Error(data.error || "Unknown error");
                        
                        showMessage("Login Successful", `Welcome back, ${data.username}!`);
                        showPage('page-home');
                        loginForm.reset();
                    } catch (error) {
                        showMessage("Login Error", `Failed to log in: ${error.message}`, true);
                    }
                });
            }


            // --- AI Chatbot Modal Logic ---
            if (openChatbotBtn) {
                openChatbotBtn.addEventListener('click', () => {
                    if(chatbotModal) chatbotModal.classList.remove('hidden');
                });
            }
            if (closeChatbotBtn) {
                closeChatbotBtn.addEventListener('click', () => {
                    if(chatbotModal) chatbotModal.classList.add('hidden');
                });
            }
            if (redirectToDoctorBtn) {
                redirectToDoctorBtn.addEventListener('click', () => {
                    if(chatbotModal) chatbotModal.classList.add('hidden');
                    showPage('page-support-group');
                });
            }
            if (chatbotForm) {
                chatbotForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const userMessage = chatbotInput.value.trim();
                    if (userMessage === "") return;
                    addChatMessage(userMessage, 'user');
                    chatbotInput.value = "";
                    handleOpenAICall(userMessage);
                });
            }
            
            function addChatMessage(message, sender) {
                if (!chatbotLog) return;
                const messageDiv = document.createElement('div');
                const messageBubble = document.createElement('div');
                messageBubble.classList.add('p-3', 'rounded-lg', 'max-w-xs', 'md:max-w-md');

                if (sender === 'user') {
                    messageDiv.classList.add('flex', 'justify-end');
                    messageBubble.classList.add('bg-blue-500', 'text-white');
                    messageBubble.textContent = message; 
                } else if (sender === 'ai-typing') {
                    messageDiv.classList.add('flex', 'ai-typing-indicator');
                    messageBubble.classList.add('bg-blue-100', 'text-gray-800', 'italic');
                    messageBubble.textContent = 'Typing...';
                } else {
                    messageDiv.classList.add('flex');
                    messageBubble.classList.add('bg-blue-100', 'text-gray-800');
                    let formattedMessage = message
                        .replace(/\n/g, '<br>') 
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); 
                    messageBubble.innerHTML = formattedMessage;
                }
                messageDiv.appendChild(messageBubble);
                chatbotLog.appendChild(messageDiv);
                chatbotLog.scrollTop = chatbotLog.scrollHeight;
            }

            function removeTypingMessage() {
                if (!chatbotLog) return;
                const typingIndicator = chatbotLog.querySelector('.ai-typing-indicator');
                if (typingIndicator) chatbotLog.removeChild(typingIndicator);
            }

            async function handleOpenAICall(message) {
                addChatMessage("...", 'ai-typing');
                const selectedLang = languageSelect ? languageSelect.value : 'en-US';

                try {
                    const response = await fetch(`${API_URL}/chat`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            message: message,
                            language: selectedLang 
                        }),
                    });
                    if (!response.ok) throw new Error("Network response was not ok");
                    
                    const data = await response.json();
                    let aiResponse = data.reply || data.error || "No response found.";
                    
                    removeTypingMessage();
                    addChatMessage(aiResponse, 'ai');
                } catch (error) {
                    console.error('Error fetching from backend:', error);
                    removeTypingMessage();
                    addChatMessage("I'm sorry, I'm having trouble connecting to the server.", 'ai');
                }
            }


            // --- Speech Recognition Logic ---
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            let recognition;
            let isListening = false;

            if (!SpeechRecognition) {
                console.warn("Speech recognition not supported in this browser.");
                if(micBtn) micBtn.style.display = 'none';
            } else {
                recognition = new SpeechRecognition();
                recognition.continuous = false; 
                recognition.interimResults = false;
                
                if (languageSelect) {
                    recognition.lang = languageSelect.value; 
                    languageSelect.addEventListener('change', () => {
                        recognition.lang = languageSelect.value; 
                    });
                } else {
                     recognition.lang = 'en-US';
                }

                if (micBtn) {
                    micBtn.addEventListener('click', () => {
                        if (isListening) {
                            recognition.stop();
                        } else {
                            try {
                                recognition.lang = languageSelect.value;
                                recognition.start();
                            } catch(e) {
                                console.error("Speech recognition start error:", e);
                                showMessage("Voice Error", "Could not start listening. Please check your microphone permissions.", true);
                            }
                        }
                    });
                }

                recognition.onstart = () => {
                    isListening = true;
                    if(micBtn) micBtn.classList.add('bg-red-200');
                    if(chatbotInput) chatbotInput.placeholder = "Listening...";
                };

                recognition.onend = () => {
                    isListening = false;
                    if(micBtn) micBtn.classList.remove('bg-red-200');
                    if(chatbotInput) chatbotInput.placeholder = "Type or press the mic to talk...";
                };

                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    const userMessage = transcript.trim();
                    
                    if (userMessage === "") return;
                    
                    addChatMessage(userMessage, 'user');
                    handleOpenAICall(userMessage);
                };

                recognition.onerror = (event) => {
                    console.error("Speech recognition error:", event.error);
                    let errorMsg = "An unknown error occurred.";
                    if (event.error === 'no-speech') {
                        errorMsg = "No speech was detected. Please try again.";
                    } else if (event.error === 'not-allowed' || event.error === 'service-not-allowed') {
                        errorMsg = "Microphone access denied. Please allow microphone access in your browser settings.";
                    } else if (event.error === 'language-not-supported') {
                        errorMsg = `The selected language (${recognition.lang}) is not supported for voice recognition in this browser. Please try typing.`;
                    }
                    if(chatbotInput) chatbotInput.placeholder = "Type or press the mic to talk...";
                    showMessage("Voice Error", errorMsg, true);
                };
            }
            
            
            // ===========================================
            //  NEW "TAKE A TEST" LOGIC STARTS HERE
            // ===========================================
            
            const testSelection = document.getElementById('test-selection');
            const testInterface = document.getElementById('test-interface');
            const testChoiceBtns = document.querySelectorAll('.test-choice-btn');
            const testBackBtn = document.getElementById('test-back-btn');
            const testTitle = document.getElementById('test-title');
            const testForm = document.getElementById('test-form');
            const testInput = document.getElementById('test-input');
            const testChatLog = document.getElementById('test-chat-log');
            const testOptionsContainer = document.getElementById('test-options');
            
            let currentTest = "";
            let questionNumber = 0;
            let currentScore = 0; // Stores the user's score for the current test

            // --- Database of all 7 questions, options, and reports ---
            const testQuestions = {
                anxiety: {
                    questions: [
                        "Feeling nervous, anxious, or on edge?",
                        "Not being able to stop or control worrying?",
                        "Worrying too much about different things?",
                        "Trouble relaxing?",
                        "Being so restless that it's hard to sit still?",
                        "Becoming easily annoyed or irritable?",
                        "Feeling afraid, as if something awful might happen?"
                    ],
                    options: [
                        { text: "Not at all", score: 0 },
                        { text: "Several days", score: 1 },
                        { text: "More than half the days", score: 2 },
                        { text: "Nearly every day", score: 3 }
                    ],
                    report: (score) => {
                        // Total score is 0-21
                        if (score <= 4) return "Your results suggest **minimal anxiety**. This is a great sign. Keep practicing mindfulness and self-care.";
                        if (score <= 9) return "Your results suggest **mild anxiety**. You may be experiencing some stress. Consider exploring the breathing games or talking to a peer.";
                        if (score <= 14) return "Your results suggest **moderate anxiety**. It seems you're finding things difficult fairly often. It might be helpful to talk to a professional. You can see our list of consultants.";
                        return "Your results suggest **severe anxiety**. It's important to seek help, and you are not alone. Please consider booking a session with a consultant or contacting a mental health helpline immediately.";
                    }
                },
                depression: {
                    questions: [
                        "Little interest or pleasure in doing things?",
                        "Feeling down, depressed, or hopeless?",
                        "Trouble falling or staying asleep, or sleeping too much?",
                        "Feeling tired or having little energy?",
                        "Poor appetite or overeating?",
                        "Feeling bad about yourself - or that you are a failure or have let yourself or your family down?",
                        "Trouble concentrating on things, such as reading the newspaper or watching television?"
                    ],
                    options: [
                        { text: "Not at all", score: 0 },
                        { text: "Several days", score: 1 },
                        { text: "More than half the days", score: 2 },
                        { text: "Nearly every day", score: 3 }
                    ],
                    report: (score) => {
                        // Total score is 0-21
                        if (score <= 4) return "Your results suggest **minimal depression**. This is a positive sign. Continue to engage in activities you enjoy and connect with others.";
                        if (score <= 9) return "Your results suggest **mild depression**. You might be having a tough time. Connecting with others or journaling (in the AI chat) could be helpful.";
                        if (score <= 14) return "Your results suggest **moderate depression**. These feelings can be heavy and isolating. We strongly recommend speaking with a peer or a professional consultant.";
                        return "Your results suggest **severe depression**. It's brave of you to take this test. Help is available and effective. Please reach out to a professional consultant or a helpline as soon as possible.";
                    }
                },
                relationship: {
                    questions: [
                        "How satisfied are you with the level of **communication** with your partner?",
                        "How often do you feel **supported** by your partner?",
                        "How well do you feel you **handle conflicts** together?",
                        "How satisfied are you with the level of **affection and intimacy**?",
                        "How often do you make **quality time** for each other?",
                        "Do you feel you share **similar values and goals** for the future?",
                        "Overall, how **happy** are you in the relationship right now?"
                    ],
                    options: [
                        { text: "Very Unsatisfied / Rarely", score: 0 },
                        { text: "Unsatisfied / Sometimes", score: 1 },
                        { text: "Neutral / Often", score: 2 },
                        { text: "Satisfied / Almost Always", score: 3 }
                    ],
                    report: (score) => {
                        // Total score is 0-21
                        if (score <= 7) return "Your results suggest there are **significant areas of dissatisfaction**. This can be very difficult. It might be helpful to open a dialogue with your partner or seek guidance from a relationship counselor.";
                        if (score <= 14) return "Your results suggest there are **some areas for improvement**. All relationships have ups and downs. Communication is key. Our peer support or consultants specializing in family therapy might be a good resource.";
                        return "Your results suggest a **generally healthy and strong relationship**. That's wonderful! Continue to nurture your bond and communicate openly.";
                    }
                }
            };
            
            // --- When a user clicks a test (Anxiety, Depression, etc.) ---
            testChoiceBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    currentTest = btn.dataset.test;
                    questionNumber = 0;
                    currentScore = 0; // Reset score
                    
                    if(testTitle) testTitle.textContent = `${btn.querySelector('h3').textContent}`;
                    if(testSelection) testSelection.classList.add('hidden');
                    if(testInterface) testInterface.classList.remove('hidden');
                    if(testChatLog) testChatLog.innerHTML = "";
                    
                    if(testForm) testForm.classList.add('hidden'); // Hide the text form
                    if(testOptionsContainer) testOptionsContainer.classList.remove('hidden'); // Show the button container
                    
                    askTestQuestion();
                });
            });

            // --- When user clicks "< Back to all tests" ---
            if(testBackBtn) {
                testBackBtn.addEventListener('click', () => {
                    if(testSelection) testSelection.classList.remove('hidden');
                    if(testInterface) testInterface.classList.add('hidden');
                    if(testForm) testForm.classList.remove('hidden'); // Show the original (but unused) form
                    if(testOptionsContainer) testOptionsContainer.classList.add('hidden'); // Hide the button container
                });
            }

            // --- Main function to ask a question ---
            function askTestQuestion() {
                if (!testOptionsContainer || !testChatLog) return;
                
                const test = testQuestions[currentTest];
                if (!test) {
                    addTestChatMessage("This test isn't available yet.", 'ai');
                    return;
                }

                testOptionsContainer.innerHTML = ""; // Clear old options

                if (questionNumber < test.questions.length) {
                    // Ask the intro question only once
                    if (questionNumber === 0) {
                        let intro = "For each question, please select how often you have been bothered by the following over the **last 2 weeks**.";
                        if (currentTest === 'relationship') {
                            intro = "Please answer the following questions about your relationship honestly.";
                        }
                        addTestChatMessage(intro, 'ai');
                    }

                    // Ask the actual question
                    setTimeout(() => {
                        addTestChatMessage(`Question ${questionNumber + 1} of ${test.questions.length}:\n${test.questions[questionNumber]}`, 'ai');
                    }, 250); // Short delay

                    // Create and show the options
                    setTimeout(() => {
                        test.options.forEach(option => {
                            const button = document.createElement('button');
                            button.className = "px-4 py-2 bg-white text-blue-600 font-semibold rounded-full shadow hover:bg-blue-50 transition-colors";
                            button.textContent = option.text;
                            button.onclick = () => {
                                handleTestAnswer(option);
                            };
                            testOptionsContainer.appendChild(button);
                        });
                    }, 750); // Delay for options to appear after question

                } else {
                    // --- Quiz is over, show the report ---
                    addTestChatMessage("Thank you for completing the assessment. Generating your report...", 'ai');
                    const reportText = test.report(currentScore);
                    
                    setTimeout(() => {
                        addTestChatMessage(reportText, 'ai');
                    }, 1500);

                    setTimeout(() => {
                        addTestChatMessage("**Disclaimer:** This is not a medical diagnosis. This tool is for informational purposes only. Please consult a professional for a formal assessment.", 'ai');
                    }, 2500);
                }
            }

            // --- When a user clicks an answer button ---
            function handleTestAnswer(option) {
                if (!testOptionsContainer) return;
                
                // 1. Add score
                currentScore += option.score;

                // 2. Show user's choice in chat
                addTestChatMessage(option.text, 'user');

                // 3. Clear buttons and show loading
                testOptionsContainer.innerHTML = '<p class="text-gray-500 italic">Loading next question...</p>';

                // 4. Increment question number
                questionNumber++;

                // 5. Ask next question after a pause
                setTimeout(askTestQuestion, 1200); 
            }

            // --- Updated chat message function to handle HTML ---
            function addTestChatMessage(message, sender) {
                if (!testChatLog) return;
                const messageDiv = document.createElement('div');
                const messageBubble = document.createElement('div');
                messageBubble.classList.add('p-3', 'rounded-lg', 'max-w-xs', 'md:max-w-md');

                // Format message for newlines and bolding
                let formattedMessage = message
                    .replace(/\n/g, '<br>') 
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); 

                if (sender === 'user') {
                    messageDiv.classList.add('flex', 'justify-end');
                    messageBubble.classList.add('bg-blue-500', 'text-white');
                } else {
                    messageDiv.classList.add('flex');
                    messageBubble.classList.add('bg-purple-100', 'text-gray-800');
                }
                
                messageBubble.innerHTML = formattedMessage; // Use innerHTML
                messageDiv.appendChild(messageBubble);
                
                testChatLog.appendChild(messageDiv);
                testChatLog.scrollTop = testChatLog.scrollHeight;
            }

            // ===========================================
            //  NEW "TAKE A TEST" LOGIC ENDS HERE
            // ===========================================


            // --- Breathing Game Logic ---
            const breathingCircle = document.getElementById('breathing-circle');
            const breathingText = document.getElementById('breathing-text');
            const startBreathingBtn = document.getElementById('start-breathing-btn');
            let isBreathing = false;
            const breathingCycle = [
                { text: 'Inhale...', duration: 4000, class: 'grow' },
                { text: 'Hold', duration: 4000, class: 'hold' },
                { text: 'Exhale...', duration: 6000, class: 'shrink' },
                { text: 'Pause', duration: 2000, class: '' },
            ];
            let cycleStep = 0;
            function runBreathingCycle() {
                if (!isBreathing || !breathingText || !breathingCircle) return;
                const step = breathingCycle[cycleStep];
                breathingText.textContent = step.text;
                breathingCircle.className = `w-64 h-64 rounded-full flex items-center justify-center text-center shadow-xl ${step.class}`;
                if (step.class === 'hold') breathingCircle.classList.add('grow');
                cycleStep = (cycleStep + 1) % breathingCycle.length;
                setTimeout(runBreathingCycle, step.duration);
            }
            if (startBreathingBtn) {
                startBreathingBtn.addEventListener('click', () => {
                    isBreathing = !isBreathing;
                    startBreathingBtn.textContent = isBreathing ? 'Stop' : 'Start';
                    if (isBreathing) {
                        cycleStep = 0;
                        runBreathingCycle();
                    } else {
                        if (breathingText) breathingText.textContent = 'Paused';
                    }
                });
            }
            
            // --- Shop Logic ---
            const addToCartBtns = document.querySelectorAll('.add-to-cart-btn');
            const cartCountEl = document.getElementById('cart-count');
            let cartCount = 0;
            addToCartBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    cartCount++;
                    if (cartCountEl) {
                        cartCountEl.textContent = cartCount;
                        cartCountEl.classList.remove('hidden');
                    }
                });
            });

            // --- Load Research Data ---
            async function loadResearch() {
                if (!researchContainer) return;
                try {
                    const response = await fetch(`${API_URL}/research`);
                    if (!response.ok) throw new Error("Failed to load research data");
                    const studies = await response.json();

                    if (studies.length === 0) {
                        researchContainer.innerHTML = '<p class="text-center text-gray-600">No research studies are available at this time.</p>';
                        return;
                    }

                    let html = '';
                    studies.forEach(study => {
                        html += `
                        <div class="bg-white rounded-lg shadow-md p-6">
                            <div class="flex flex-col md:flex-row justify-between md:items-center">
                                <h3 class="text-2xl font-semibold text-blue-700">${study.title}</h3>
                                <span class="text-lg font-medium text-green-600 mt-2 md:mt-0">${study.compensation}</span>
                            </div>
                            <p class="text-gray-700 mt-4">${study.description}</p>
                            <button class="mt-6 px-6 py-2 bg-blue-500 text-white font-semibold rounded-full hover:bg-blue-600 transition-colors">Learn More & Join</button>
                        </div>
                        `;
                    });
                    researchContainer.innerHTML = html;
                } catch (error) {
                    console.error("Error loading research:", error);
                    researchContainer.innerHTML = `<p class="text-center text-red-600">Error: ${error.message}. Please make sure the backend server is running.</p>`;
                }
            }

            // --- Initial Load ---
            loadResearch(); // Load research data when the app starts
        });
    </script>
    </body>
</html>